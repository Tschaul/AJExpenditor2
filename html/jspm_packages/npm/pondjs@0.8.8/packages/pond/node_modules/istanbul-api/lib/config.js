/* */ 
(function(process) {
  var path = require('path'),
      fs = require('fs'),
      existsSync = fs.existsSync,
      CAMEL_PATTERN = /([a-z])([A-Z])/g,
      YML_PATTERN = /\.ya?ml$/,
      yaml = require('../../js-yaml/index'),
      libReport = require('../../istanbul-lib-report/index'),
      inputError = require('./input-error');
  function defaultConfig() {
    var ret = {
      verbose: false,
      instrumentation: {
        root: '.',
        extensions: ['.js'],
        'default-excludes': true,
        excludes: [],
        variable: '__coverage__',
        compact: true,
        'preserve-comments': false,
        'complete-copy': false,
        'save-baseline': false,
        'baseline-file': './coverage/coverage-baseline.raw.json',
        'include-all-sources': false,
        'include-pid': false,
        'es-modules': false,
        'auto-wrap': false
      },
      reporting: {
        print: 'summary',
        reports: ['lcov'],
        dir: './coverage',
        summarizer: 'pkg',
        'report-config': {}
      },
      hooks: {
        'hook-run-in-context': false,
        'post-require-hook': null,
        'handle-sigint': false
      },
      check: {
        global: {
          statements: 0,
          lines: 0,
          branches: 0,
          functions: 0,
          excludes: []
        },
        each: {
          statements: 0,
          lines: 0,
          branches: 0,
          functions: 0,
          excludes: []
        }
      }
    };
    ret.reporting.watermarks = libReport.getDefaultWatermarks();
    ret.reporting['report-config'] = {};
    return ret;
  }
  function dasherize(word) {
    return word.replace(CAMEL_PATTERN, function(match, lch, uch) {
      return lch + '-' + uch.toLowerCase();
    });
  }
  function isScalar(v) {
    if (v === null) {
      return true;
    }
    return v !== undefined && !Array.isArray(v) && typeof v !== 'object';
  }
  function isObject(v) {
    return typeof v === 'object' && v !== null && !Array.isArray(v);
  }
  function mergeObjects(explicit, template, bothWays) {
    var ret = {},
        keys = Object.keys(template);
    if (bothWays) {
      keys.push.apply(keys, Object.keys(explicit));
    }
    keys.forEach(function(k) {
      var v1 = template[k],
          v2 = explicit[k];
      if (Array.isArray(v1)) {
        ret[k] = Array.isArray(v2) && v2.length > 0 ? v2 : v1;
      } else if (isObject(v1)) {
        v2 = isObject(v2) ? v2 : {};
        ret[k] = mergeObjects(v2, v1, bothWays);
      } else if (!v1 && v2) {
        ret[k] = v2;
      } else {
        ret[k] = isScalar(v2) ? v2 : v1;
      }
    });
    return ret;
  }
  function mergeDefaults(explicit, implicit) {
    explicit = explicit || {};
    var initialMerge = mergeObjects(explicit || {}, implicit),
        explicitReportConfig = (explicit.reporting || {})['report-config'] || {},
        implicitReportConfig = initialMerge.reporting['report-config'] || {};
    initialMerge.reporting['report-config'] = mergeObjects(explicitReportConfig, implicitReportConfig, true);
    return initialMerge;
  }
  function addMethods() {
    var args = Array.prototype.slice.call(arguments),
        cons = args.shift();
    args.forEach(function(arg) {
      var property = dasherize(arg);
      cons.prototype[arg] = function() {
        return this.config[property];
      };
    });
  }
  function InstrumentOptions(config) {
    this.config = config;
  }
  addMethods(InstrumentOptions, 'extensions', 'defaultExcludes', 'completeCopy', 'variable', 'compact', 'preserveComments', 'saveBaseline', 'baselineFile', 'esModules', 'includeAllSources', 'includePid', 'autoWrap');
  InstrumentOptions.prototype.root = function() {
    return path.resolve(this.config.root);
  };
  InstrumentOptions.prototype.excludes = function(excludeTests) {
    var defs;
    if (this.defaultExcludes()) {
      defs = ['**/node_modules/**'];
      if (excludeTests) {
        defs = defs.concat(['**/test/**', '**/tests/**']);
      }
      return defs.concat(this.config.excludes);
    }
    return this.config.excludes;
  };
  InstrumentOptions.prototype.getInstrumenterOpts = function() {
    return {
      coverageVariable: this.variable(),
      compact: this.compact(),
      preserveComments: this.preserveComments(),
      esModules: this.esModules(),
      autoWrap: this.autoWrap()
    };
  };
  function ReportingOptions(config) {
    this.config = config;
  }
  addMethods(ReportingOptions, 'print', 'reports', 'dir', 'reportConfig', 'summarizer');
  function isInvalidMark(v, key) {
    var prefix = 'Watermark for [' + key + '] :';
    if (v.length !== 2) {
      return prefix + 'must be an array of length 2';
    }
    v[0] = Number(v[0]);
    v[1] = Number(v[1]);
    if (isNaN(v[0]) || isNaN(v[1])) {
      return prefix + 'must have valid numbers';
    }
    if (v[0] < 0 || v[1] < 0) {
      return prefix + 'must be positive numbers';
    }
    if (v[1] > 100) {
      return prefix + 'cannot exceed 100';
    }
    if (v[1] <= v[0]) {
      return prefix + 'low must be less than high';
    }
    return null;
  }
  ReportingOptions.prototype.watermarks = function() {
    var v = this.config.watermarks,
        defs = libReport.getDefaultWatermarks(),
        ret = {};
    Object.keys(defs).forEach(function(k) {
      var mark = v[k],
          message = isInvalidMark(mark, k);
      if (message) {
        console.error(message);
        ret[k] = defs[k];
      } else {
        ret[k] = mark;
      }
    });
    return ret;
  };
  function HookOptions(config) {
    this.config = config;
  }
  addMethods(HookOptions, 'hookRunInContext', 'postRequireHook', 'handleSigint');
  function Configuration(obj, overrides) {
    var config = mergeDefaults(obj, defaultConfig(true));
    if (isObject(overrides)) {
      config = mergeDefaults(overrides, config);
    }
    if (config.verbose) {
      console.error('Using configuration');
      console.error('-------------------');
      console.error(yaml.safeDump(config, {
        indent: 4,
        flowLevel: 3
      }));
      console.error('-------------------\n');
    }
    this.verbose = config.verbose;
    this.instrumentation = new InstrumentOptions(config.instrumentation);
    this.reporting = new ReportingOptions(config.reporting);
    this.hooks = new HookOptions(config.hooks);
    this.check = config.check;
  }
  function loadFile(file, overrides) {
    var defaultConfigFile = path.resolve('.istanbul.yml'),
        configObject;
    if (file) {
      if (!existsSync(file)) {
        throw inputError.create('Invalid configuration file specified:' + file);
      }
    } else {
      if (existsSync(defaultConfigFile)) {
        file = defaultConfigFile;
      }
    }
    if (file) {
      if (overrides && overrides.verbose === true) {
        console.error('Loading config: ' + file);
      }
      configObject = file.match(YML_PATTERN) ? yaml.safeLoad(fs.readFileSync(file, 'utf8'), {filename: file}) : require(path.resolve(file));
    }
    return new Configuration(configObject, overrides);
  }
  function loadObject(obj, overrides) {
    return new Configuration(obj, overrides);
  }
  module.exports = {
    loadFile: loadFile,
    loadObject: loadObject,
    defaultConfig: defaultConfig
  };
})(require('process'));
